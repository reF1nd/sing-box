name: Android ARM64 Fixed Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.10.0)'
        required: true
        type: string

env:
  BUILD_TAGS: "with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale"

jobs:
  prepare:
    name: Prepare Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: ${VERSION}"

  build_android_arm64:
    name: Build Android ARM64
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.24

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28

      - name: Install build tool
        run: |
          echo "=== å®‰è£…æ„å»ºå·¥å…· ==="
          go install -v ./cmd/internal/build
          which build
          
          echo "=== Go ç¯å¢ƒä¿¡æ¯ ==="
          go version
          go env GOOS GOARCH CGO_ENABLED

      - name: Build Android ARM64 Binary
        run: |
          set -xeuo pipefail
          echo "=== å¼€å§‹ Android ARM64 æ„å»º ==="
          
          # å®‰è£…æ„å»ºå·¥å…·
          go install -v ./cmd/internal/build
          
          # è®¾ç½® NDK ç¯å¢ƒå˜é‡
          export ANDROID_NDK_HOME="${{ steps.setup-ndk.outputs.ndk-path }}"
          export NDK_TOOLCHAIN_DIR="${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          
          # ä½¿ç”¨å®Œæ•´è·¯å¾„è®¾ç½®ç¼–è¯‘å™¨
          export CC="${NDK_TOOLCHAIN_DIR}/aarch64-linux-android21-clang"
          export CXX="${NDK_TOOLCHAIN_DIR}/aarch64-linux-android21-clang++"
          
          # éªŒè¯ NDK ç¯å¢ƒ
          echo "=== éªŒè¯ NDK ç¯å¢ƒ ==="
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "NDK_TOOLCHAIN_DIR: $NDK_TOOLCHAIN_DIR"
          echo "CC: $CC"
          echo "CXX: $CXX"
          
          # æ£€æŸ¥å·¥å…·é“¾ç›®å½•
          if [ -d "$NDK_TOOLCHAIN_DIR" ]; then
            echo "âœ… æ‰¾åˆ° NDK å·¥å…·é“¾ç›®å½•"
            ls -la "$NDK_TOOLCHAIN_DIR" | grep aarch64-linux-android21 || true
          else
            echo "âŒ æœªæ‰¾åˆ° NDK å·¥å…·é“¾ç›®å½•: $NDK_TOOLCHAIN_DIR"
            exit 1
          fi
          
          # éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶
          if [ -f "$CC" ]; then
            echo "âœ… æ‰¾åˆ° Android ç¼–è¯‘å™¨: $CC"
            $CC --version
          else
            echo "âŒ æœªæ‰¾åˆ° Android ç¼–è¯‘å™¨æ–‡ä»¶: $CC"
            echo "å¯ç”¨çš„ aarch64 ç¼–è¯‘å™¨:"
            ls -la "$NDK_TOOLCHAIN_DIR" | grep aarch64 || true
            exit 1
          fi
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p dist
          
          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
          echo "=== æ„å»º Android ARM64 äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          echo "æ„å»ºæ ‡ç­¾: ${BUILD_TAGS}"
          echo "ç¯å¢ƒå˜é‡:"
          echo "  CGO_ENABLED=$CGO_ENABLED"
          echo "  BUILD_GOOS=$BUILD_GOOS"
          echo "  BUILD_GOARCH=$BUILD_GOARCH"
          echo "  CC=$CC"
          echo "  CXX=$CXX"
          
          GOOS=$BUILD_GOOS GOARCH=$BUILD_GOARCH build go build -v -trimpath -o dist/sing-box \
            -tags "${BUILD_TAGS}" \
            -ldflags "-s -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ needs.prepare.outputs.version }}" \
            ./cmd/sing-box
          
          # éªŒè¯æ„å»ºç»“æœ
          echo "=== éªŒè¯æ„å»ºç»“æœ ==="
          ls -la dist/
          file dist/sing-box
          
          # è®¾ç½®å¯æ‰§è¡Œæƒé™
          chmod +x dist/sing-box
          
          echo "âœ… Android ARM64 æ„å»ºå®Œæˆ"
        env:
          CGO_ENABLED: "1"
          BUILD_GOOS: linux
          BUILD_GOARCH: arm64

      - name: Create archive
        run: |
          cd dist
          tar -czf sing-box-${{ needs.prepare.outputs.version }}-android-arm64.tar.gz sing-box
          ls -la

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-binary-fixed
          path: |
            dist/sing-box
            dist/sing-box-${{ needs.prepare.outputs.version }}-android-arm64.tar.gz

      - name: Show build summary
        run: |
          echo "ğŸ‰ Android ARM64 æ„å»ºå®Œæˆ!"
          echo "ç‰ˆæœ¬: ${{ needs.prepare.outputs.version }}"
          echo "æ–‡ä»¶:"
          ls -la dist/
          echo "æ–‡ä»¶ç±»å‹:"
          file dist/sing-box
