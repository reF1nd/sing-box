name: Android ARM64 Debug Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.10.0)'
        required: true
        type: string

env:
  BUILD_TAGS: "with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale"

jobs:
  prepare:
    name: Prepare Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: ${VERSION}"

  build_android_arm64:
    name: Build Android ARM64
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.24

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28

      - name: Build Android ARM64 Binary
        run: |
          set -xeuo pipefail
          echo "=== å¼€å§‹ Android ARM64 æ„å»º ==="
          
          go install -v ./cmd/internal/build
          export CC='aarch64-linux-android21-clang'
          export CXX="${CC}++"
          
          mkdir -p dist
          
          GOOS=$BUILD_GOOS GOARCH=$BUILD_GOARCH build go build -v -trimpath -o dist/sing-box -tags "${BUILD_TAGS}" \
            -ldflags '-s -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ needs.prepare.outputs.version }}' \
            ./cmd/sing-box
          
          ls -la dist/
          file dist/sing-box
          chmod +x dist/sing-box
          
          echo "âœ… Android ARM64 æ„å»ºå®Œæˆ"
        env:
          CGO_ENABLED: "1"
          BUILD_GOOS: android
          BUILD_GOARCH: arm64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-binary-debug
          path: dist/sing-box

  push_to_magisk:
    name: Push to box_for_magisk
    runs-on: ubuntu-latest
    needs: [prepare, build_android_arm64]
    steps:
      - name: Download Android ARM64 binary
        uses: actions/download-artifact@v4
        with:
          name: android-arm64-binary-debug
          path: android_binary/

      - name: Verify downloaded files
        run: |
          echo "=== æŸ¥çœ‹ä¸‹è½½çš„æ–‡ä»¶ ==="
          ls -la android_binary/
          file android_binary/sing-box
          chmod +x android_binary/sing-box
          echo "æ–‡ä»¶å¤§å°: $(stat -c%s android_binary/sing-box) bytes"
          echo "æ–‡ä»¶ MD5: $(md5sum android_binary/sing-box)"

      - name: Checkout box_for_magisk repository
        uses: actions/checkout@v4
        with:
          repository: ridesnails/box_for_magisk
          ref: simple
          token: ${{ secrets.GITHUB_TOKEN }}
          path: box_for_magisk

      - name: Setup Git
        run: |
          cd box_for_magisk
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Check current state
        run: |
          cd box_for_magisk
          echo "=== å½“å‰ä»“åº“çŠ¶æ€ ==="
          git status
          git log --oneline -5
          
          echo "=== æ£€æŸ¥ç°æœ‰æ–‡ä»¶ ==="
          if [ -f "box/bin/sing-box" ]; then
            echo "ç°æœ‰æ–‡ä»¶å¤§å°: $(stat -c%s box/bin/sing-box) bytes"
            echo "ç°æœ‰æ–‡ä»¶ MD5: $(md5sum box/bin/sing-box)"
            echo "ç°æœ‰æ–‡ä»¶ä¿®æ”¹æ—¶é—´: $(stat -c%y box/bin/sing-box)"
          else
            echo "æ–‡ä»¶ä¸å­˜åœ¨: box/bin/sing-box"
          fi

      - name: Update binary file
        run: |
          echo "=== æ›´æ–°äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          
          mkdir -p box_for_magisk/box/bin
          
          # å¤‡ä»½ç°æœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "box_for_magisk/box/bin/sing-box" ]; then
            cp box_for_magisk/box/bin/sing-box box_for_magisk/box/bin/sing-box.backup
            echo "å·²å¤‡ä»½ç°æœ‰æ–‡ä»¶"
          fi
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          cp android_binary/sing-box box_for_magisk/box/bin/sing-box
          chmod 755 box_for_magisk/box/bin/sing-box
          
          echo "=== éªŒè¯æ›´æ–°åçš„æ–‡ä»¶ ==="
          ls -la box_for_magisk/box/bin/
          file box_for_magisk/box/bin/sing-box
          echo "æ–°æ–‡ä»¶å¤§å°: $(stat -c%s box_for_magisk/box/bin/sing-box) bytes"
          echo "æ–°æ–‡ä»¶ MD5: $(md5sum box_for_magisk/box/bin/sing-box)"

      - name: Force commit and push changes
        run: |
          cd box_for_magisk
          
          echo "=== å¼ºåˆ¶æ£€æŸ¥å˜æ›´ ==="
          
          # æ·»åŠ æ–‡ä»¶åˆ° Git
          git add box/bin/sing-box
          
          echo "=== Git çŠ¶æ€ ==="
          git status
          
          echo "=== æ£€æŸ¥æš‚å­˜åŒºå˜æ›´ ==="
          if git diff --cached --quiet; then
            echo "ğŸ“ æš‚å­˜åŒºæ²¡æœ‰å˜æ›´"
            
            # å°è¯•å¼ºåˆ¶æ›´æ–°æ–‡ä»¶æ—¶é—´æˆ³
            touch box/bin/sing-box
            git add box/bin/sing-box
            
            if git diff --cached --quiet; then
              echo "ğŸ“ æ–‡ä»¶å†…å®¹ç¡®å®æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
              echo "è¿™æ„å‘³ç€æ–°æ„å»ºçš„æ–‡ä»¶ä¸ä»“åº“ä¸­çš„æ–‡ä»¶å®Œå…¨ç›¸åŒ"
            else
              echo "ğŸ“ æ—¶é—´æˆ³æ›´æ–°åå‘ç°å˜æ›´ï¼Œå‡†å¤‡æäº¤"
              git commit -m "Update sing-box binary to ${{ needs.prepare.outputs.version }} (Android ARM64) - timestamp update"
              git push origin simple
              echo "âœ… æˆåŠŸæ¨é€åˆ° ridesnails/box_for_magisk:simple"
            fi
          else
            echo "ğŸ“ å‘ç°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤"
            echo "å˜æ›´è¯¦æƒ…:"
            git diff --cached --stat
            git diff --cached --name-only
            
            git commit -m "Update sing-box binary to ${{ needs.prepare.outputs.version }} (Android ARM64)"
            git push origin simple
            echo "âœ… æˆåŠŸæ¨é€åˆ° ridesnails/box_for_magisk:simple"
          fi

      - name: Verify push result
        run: |
          cd box_for_magisk
          echo "=== éªŒè¯æ¨é€ç»“æœ ==="
          git log --oneline -3
          echo "=== æœ€æ–°æäº¤è¯¦æƒ… ==="
          git show --stat HEAD
