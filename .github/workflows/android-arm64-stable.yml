name: Android ARM64 Stable Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.10.0)'
        required: true
        type: string

env:
  BUILD_TAGS: "with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale"

jobs:
  prepare:
    name: Prepare Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit_info: ${{ steps.commit.outputs.info }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: ${VERSION}"

      - name: Get commit info
        id: commit
        run: |
          COMMIT_INFO=$(git log -1 --pretty=format:"%h - %s (%an)")
          echo "info=${COMMIT_INFO}" >> $GITHUB_OUTPUT
          echo "ğŸ“ æäº¤ä¿¡æ¯: ${COMMIT_INFO}"

      - name: Generate changelog
        id: changelog
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGELOG=$(git log --oneline --no-merges $(git describe --tags --abbrev=0 HEAD~1)..HEAD | head -10 | sed 's/^/â€¢ /' || echo "â€¢ é¦–æ¬¡å‘å¸ƒ")
          else
            CHANGELOG="â€¢ æ‰‹åŠ¨è§¦å‘æ„å»º"
          fi
          
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="â€¢ æ— é‡è¦å˜æ›´"
          fi
          
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build_android_arm64:
    name: Build Android ARM64
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ^1.24

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28

      - name: Build Android ARM64 Binary
        run: |
          set -xeuo pipefail
          echo "=== å¼€å§‹ Android ARM64 æ„å»º ==="
          
          # å®‰è£…æ„å»ºå·¥å…·
          go install -v ./cmd/internal/build
          
          # è®¾ç½®ç¼–è¯‘å™¨
          export CC='aarch64-linux-android21-clang'
          export CXX="${CC}++"
          
          echo "=== éªŒè¯ç¯å¢ƒ ==="
          echo "CC: $CC"
          echo "CXX: $CXX"
          echo "CGO_ENABLED: $CGO_ENABLED"
          echo "BUILD_GOOS: $BUILD_GOOS"
          echo "BUILD_GOARCH: $BUILD_GOARCH"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p dist
          
          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
          echo "=== æ„å»º Android ARM64 äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          GOOS=$BUILD_GOOS GOARCH=$BUILD_GOARCH build go build -v -trimpath -o dist/sing-box -tags "${BUILD_TAGS}" \
            -ldflags '-s -buildid= -X github.com/sagernet/sing-box/constant.Version=${{ needs.prepare.outputs.version }}' \
            ./cmd/sing-box
          
          # éªŒè¯æ„å»ºç»“æœ
          echo "=== éªŒè¯æ„å»ºç»“æœ ==="
          ls -la dist/
          file dist/sing-box
          chmod +x dist/sing-box
          
          echo "âœ… Android ARM64 æ„å»ºå®Œæˆ"
        env:
          CGO_ENABLED: "1"
          BUILD_GOOS: android
          BUILD_GOARCH: arm64

      - name: Create archive
        run: |
          cd dist
          tar -czf sing-box-${{ needs.prepare.outputs.version }}-android-arm64.tar.gz sing-box
          ls -la

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-arm64-binary-stable
          path: |
            dist/sing-box
            dist/sing-box-${{ needs.prepare.outputs.version }}-android-arm64.tar.gz

  push_to_magisk:
    name: Push to box_for_magisk
    runs-on: ubuntu-latest
    needs: [prepare, build_android_arm64]
    steps:
      - name: Download Android ARM64 binary
        uses: actions/download-artifact@v4
        with:
          name: android-arm64-binary-stable
          path: android_binary/

      - name: Verify downloaded files
        run: |
          echo "=== æŸ¥çœ‹ä¸‹è½½çš„æ–‡ä»¶ ==="
          ls -la android_binary/
          file android_binary/sing-box
          chmod +x android_binary/sing-box

      - name: Checkout box_for_magisk repository
        uses: actions/checkout@v4
        with:
          repository: ridesnails/box_for_magisk
          ref: simple
          token: ${{ secrets.BOX_FOR_MAGISK_TOKEN || secrets.GITHUB_TOKEN }}
          path: box_for_magisk

      - name: Setup Git
        run: |
          cd box_for_magisk
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Update binary file
        run: |
          echo "=== æ›´æ–°äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p box_for_magisk/box/bin
          
          # å¤åˆ¶æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          cp android_binary/sing-box box_for_magisk/box/bin/sing-box
          chmod 755 box_for_magisk/box/bin/sing-box
          
          # éªŒè¯æ–‡ä»¶
          echo "=== éªŒè¯æ›´æ–°åçš„æ–‡ä»¶ ==="
          ls -la box_for_magisk/box/bin/
          file box_for_magisk/box/bin/sing-box

      - name: Commit and push changes
        run: |
          cd box_for_magisk

          echo "=== æ£€æŸ¥ Git çŠ¶æ€ ==="
          git status

          echo "=== æ£€æŸ¥æ–‡ä»¶å·®å¼‚ ==="
          git diff --name-only || true
          git diff --stat || true

          echo "=== æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯ ==="
          if [ -f "box/bin/sing-box" ]; then
            echo "å½“å‰æ–‡ä»¶å¤§å°: $(stat -c%s box/bin/sing-box) bytes"
            echo "å½“å‰æ–‡ä»¶ä¿®æ”¹æ—¶é—´: $(stat -c%y box/bin/sing-box)"
            echo "æ–‡ä»¶ MD5: $(md5sum box/bin/sing-box)"
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: box/bin/sing-box"
          fi

          # å¼ºåˆ¶æ·»åŠ æ–‡ä»¶å¹¶æ£€æŸ¥çŠ¶æ€
          git add box/bin/sing-box

          echo "=== æ·»åŠ æ–‡ä»¶åçš„çŠ¶æ€ ==="
          git status

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --cached --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "è¿™å¯èƒ½æ„å‘³ç€æ–‡ä»¶å†…å®¹ä¸ä»“åº“ä¸­çš„å®Œå…¨ç›¸åŒ"
          else
            echo "ğŸ“ å‘ç°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤"
            echo "å˜æ›´è¯¦æƒ…:"
            git diff --cached --stat

            git commit -m "Update sing-box binary to ${{ needs.prepare.outputs.version }} (Android ARM64)"
            git push origin simple
            echo "âœ… æˆåŠŸæ¨é€åˆ° ridesnails/box_for_magisk:simple"
          fi

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [prepare, build_android_arm64, push_to_magisk]
    if: always()
    steps:
      - name: Send Telegram notification
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº† Telegram
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "ğŸ“± Telegram æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # è·å–æ„å»ºçŠ¶æ€
          BUILD_STATUS="${{ needs.build_android_arm64.result }}"
          PUSH_STATUS="${{ needs.push_to_magisk.result }}"
          
          # è®¾ç½®çŠ¶æ€å›¾æ ‡
          if [ "$BUILD_STATUS" = "success" ]; then
            BUILD_ICON="âœ…"
          else
            BUILD_ICON="âŒ"
          fi
          
          if [ "$PUSH_STATUS" = "success" ]; then
            PUSH_ICON="âœ…"
            OVERALL_STATUS="âœ… æ„å»ºå’Œéƒ¨ç½²æˆåŠŸ"
          else
            PUSH_ICON="âŒ"
            OVERALL_STATUS="âŒ æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
          fi
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          MESSAGE="ğŸ“± **sing-box Android ARM64 æ„å»ºæŠ¥å‘Š**%0A%0A${OVERALL_STATUS}%0A%0AğŸ·ï¸ **ç‰ˆæœ¬**: \`${{ needs.prepare.outputs.version }}\`%0AğŸ• **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')%0A%0AğŸ“‹ **æäº¤ä¿¡æ¯**:%0A\`\`\`%0A${{ needs.prepare.outputs.commit_info }}\`\`\`%0A%0AğŸ”§ **æ„å»ºçŠ¶æ€**:%0Aâ€¢ Android ARM64 æ„å»º: ${BUILD_ICON}%0Aâ€¢ Magisk ä»“åº“æ¨é€: ${PUSH_ICON}%0A%0AğŸ“¦ **éƒ¨ç½²ä¿¡æ¯**:%0Aâ€¢ ç›®æ ‡ä»“åº“: ridesnails/box_for_magisk%0Aâ€¢ ç›®æ ‡åˆ†æ”¯: simple%0Aâ€¢ æ–‡ä»¶è·¯å¾„: box/bin/sing-box%0Aâ€¢ æ–‡ä»¶æƒé™: 755 (å¯æ‰§è¡Œ)%0A%0AğŸ“ **æ›´æ–°æ—¥å¿—**:%0A${{ needs.prepare.outputs.changelog }}%0A%0AğŸ”— **è¯¦ç»†æ—¥å¿—**: [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          # å‘é€æ¶ˆæ¯åˆ° Telegram
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true" || echo "Failed to send notification"
        continue-on-error: true
