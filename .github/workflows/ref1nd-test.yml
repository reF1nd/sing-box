name: reF1nd Test Build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Test tag name containing 'reF1nd'"
        required: true
        type: string
        default: "v1.0.0-reF1nd-test"

jobs:
  test_syntax:
    name: Test Workflow Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test version extraction
        run: |
          VERSION="${{ inputs.tag }}"
          echo "Version: ${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
        id: version

      - name: Test message formatting
        run: |
          MESSAGE="🎯 **sing-box reF1nd 测试报告**%0A%0A✅ 语法测试成功%0A%0A🏷️ **版本**: \`${{ steps.version.outputs.version }}\`%0A🕐 **测试时间**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Message formatted successfully"
          echo "MESSAGE=${MESSAGE}" >> $GITHUB_ENV

      - name: Test file operations
        run: |
          mkdir -p test_dist
          echo "test binary" > test_dist/sing-box
          echo "✅ File operations test passed"

      - name: Test packaging simulation
        run: |
          echo "Simulating package creation..."
          echo "-s dir" > .fpm_test
          echo "--name sing-box" >> .fpm_test
          echo "--version 1.0.0" >> .fpm_test
          echo "✅ Package configuration test passed"

      - name: Test artifact upload
        uses: actions/upload-artifact@v4
        with:
          name: test-artifact
          path: test_dist/
          retention-days: 1

      - name: Summary
        run: |
          echo "🎉 所有语法测试通过！"
          echo "✅ 版本提取: ${{ steps.version.outputs.version }}"
          echo "✅ 消息格式化: 成功"
          echo "✅ 文件操作: 成功"
          echo "✅ 打包配置: 成功"
          echo "✅ 产物上传: 成功"
